'use strict';

exports.__esModule = true;

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _babelStandalone = require('babel-standalone');

var _requireModuleDefault = require('./requireModuleDefault');

var _requireModuleDefault2 = _interopRequireDefault(_requireModuleDefault);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var presets = ['es2015-loose', 'react', 'stage-2'];

var cached = {};
var cachedTransform = function cachedTransform(jsx) {
  if (cached[jsx]) {
    return cached[jsx];
  }
  var transformed = (0, _babelStandalone.transform)(jsx, { compact: false, presets: presets }).code;
  cached[jsx] = transformed;
  return transformed;
};

var missingTransformError = {
  error: 'Please include [babel-standalone](https://github.com/Daniel15/babel-standalone) before Catalog.'
};

exports.default = function (jsx, imports) {
  // Check for transform to provide a better error message
  try {
    _babelStandalone.transform;
  } catch (error) {
    return missingTransformError;
  }

  try {
    var importKeys = Object.keys(imports).filter(function (k) {
      return imports[k];
    });
    var importModules = importKeys.map(function (k) {
      return (0, _requireModuleDefault2.default)(imports[k]);
    });
    var transformed = cachedTransform(jsx);
    // Heuristic: return the _first_ top-level call to React.createElement.
    // In the code generated by Babel, we can assume this is either after a newline or at the beginning of the code
    var code = transformed.replace(/(^|\n)React\.createElement/, ';return React.createElement');
    var element = new (Function.prototype.bind.apply(Function, [null].concat(['React'], importKeys, [code])))().apply(undefined, [_react2.default].concat(importModules)); // eslint-disable-line no-new-func
    return { code: code, element: element };
  } catch (error) {
    return { error: error };
  }
};